# bot/handlers/registration.py
from aiogram import Router, F
from aiogram.types import Message
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
import logging


logger = logging.getLogger(__name__)

class RegistrationStates(StatesGroup):
    waiting_for_chain = State()
    waiting_for_pharmacy = State()
    confirm_registration = State()

router = Router()
# bot/handlers/registration.py (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
@router.message(Command("start"))
async def cmd_start(message: Message, state: FSMContext):
    """–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è"""
    await message.answer(
        "üë®‚Äç‚öïÔ∏è –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É Novamedika!\n\n"
        "–î–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∫–∞–∫ —Ñ–∞—Ä–º–∞—Ü–µ–≤—Ç –æ—Ç–ø—Ä–∞–≤—å—Ç–µ:\n"
        "‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ –∞–ø—Ç–µ–∫–∏\n"
        "‚Ä¢ –ù–æ–º–µ—Ä –∞–ø—Ç–µ–∫–∏\n"
        "‚Ä¢ –ì–æ—Ä–æ–¥\n\n"
        "–ü—Ä–∏–º–µ—Ä:\n"
        "–ù–æ–≤–∞–º–µ–¥–∏–∫–∞ ‚Ññ1, –ú–æ—Å–∫–≤–∞"
    )
    await state.set_state(RegistrationStates.waiting_pharmacy_info)

@router.message(RegistrationStates.waiting_pharmacy_info)
# registration.py - –û–ë–ù–û–í–ò–¢–¨ —Ñ—É–Ω–∫—Ü–∏—é process_pharmacy_info
async def process_pharmacy_info(message: Message, state: FSMContext, db: AsyncSession):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–ø—Ç–µ–∫–µ"""
    try:
        text = message.text.strip()
        pharmacy_data = parse_pharmacy_info(text)

        telegram_data = {
            "telegram_user_id": message.from_user.id,
            "first_name": message.from_user.first_name,
            "last_name": message.from_user.last_name,
            "telegram_username": message.from_user.username,
            "pharmacy_name": pharmacy_data.get("pharmacy_name", ""),
            "pharmacy_number": pharmacy_data.get("pharmacy_number", ""),
            "pharmacy_city": pharmacy_data.get("pharmacy_city", ""),
            "pharmacy_chain": "–ù–æ–≤–∞–º–µ–¥–∏–∫–∞"  # –∏–ª–∏ –∏–∑–≤–ª–µ—á—å –∏–∑ –¥–∞–Ω–Ω—ã—Ö
        }

        # –í—ã–∑—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        from routers.pharmacist_auth import register_pharmacist
        result = await register_pharmacist(telegram_data, db)

        await message.answer("‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!")
        await state.clear()

    except Exception as e:
        await message.answer("‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")

@router.message(Command("login"))
async def cmd_login(message: Message, db: AsyncSession):
    """–í—Ö–æ–¥ –¥–ª—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞—Ä–º–∞—Ü–µ–≤—Ç–æ–≤"""
    from routers.pharmacist_auth import pharmacist_login

    try:
        result = await pharmacist_login(message.from_user.id, db)

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω—É–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)
        await message.answer(
            "‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!\n\n"
            "–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥"
        )

    except Exception as e:
        await message.answer(
            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏. –í–æ–∑–º–æ–∂–Ω–æ, –≤—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã.\n"
            "–î–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start"
        )

@router.message(Command("help"))
async def cmd_help(message: Message):
    """–°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º"""
    help_text = (
        "üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n\n"
        "/start - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ñ–∞—Ä–º–∞—Ü–µ–≤—Ç–∞\n"
        "/login - –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É\n"
        "/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n\n"
        "–ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤—ã —Å–º–æ–∂–µ—Ç–µ:\n"
        "‚Ä¢ –ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö\n"
        "‚Ä¢ –û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n"
        "‚Ä¢ –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –æ—Ç–≤–µ—Ç–æ–≤"
    )
    await message.answer(help_text)

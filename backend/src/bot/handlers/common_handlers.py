# bot/handlers/common_handlers.py
from aiogram import Router, F
from aiogram.types import Message
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from sqlalchemy.ext.asyncio import AsyncSession
import logging

from routers.pharmacist_auth import get_pharmacist_by_telegram_id
from utils.time_utils import get_utc_now_naive
from sqlalchemy import select, func
from db.qa_models import Pharmacist

logger = logging.getLogger(__name__)
router = Router()

@router.message(Command("help"))
async def universal_help(message: Message, db: AsyncSession):
    """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    try:
        pharmacist = await get_pharmacist_by_telegram_id(message.from_user.id, db)

        # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–Ω–ª–∞–π–Ω —Ñ–∞—Ä–º–∞—Ü–µ–≤—Ç–æ–≤
        from datetime import timedelta
        online_threshold = get_utc_now_naive() - timedelta(minutes=5)
        result = await db.execute(
            select(func.count(Pharmacist.uuid))
            .where(Pharmacist.is_online == True)
            .where(Pharmacist.last_seen >= online_threshold)
        )
        online_count = result.scalar() or 0

        if pharmacist:
            # üìã –ü–û–õ–ù–ê–Ø –°–ü–†–ê–í–ö–ê –î–õ–Ø –§–ê–†–ú–ê–¶–ï–í–¢–û–í
            help_text = (
                f"üë®‚Äç‚öïÔ∏è **–°–ø—Ä–∞–≤–∫–∞ –¥–ª—è —Ñ–∞—Ä–º–∞—Ü–µ–≤—Ç–æ–≤**\n\n"

                f"üìä **–¢–µ–∫—É—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**\n"
                f"‚Ä¢ –û–Ω–ª–∞–π–Ω —Ñ–∞—Ä–º–∞—Ü–µ–≤—Ç–æ–≤: {online_count}\n"
                f"‚Ä¢ –í–∞—à —Å—Ç–∞—Ç—É—Å: {'üü¢ –û–Ω–ª–∞–π–Ω' if pharmacist.is_online else 'üî¥ –û—Ñ–ª–∞–π–Ω'}\n"
                f"‚Ä¢ –ê–ø—Ç–µ–∫–∞: {pharmacist.pharmacy_info.get('chain', '–ù–µ —É–∫–∞–∑–∞–Ω–∞')} ‚Ññ{pharmacist.pharmacy_info.get('number', '–ù–µ —É–∫–∞–∑–∞–Ω')}\n\n"

                "üõ† **–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:**\n"
                "‚Ä¢ /online - –ø–µ—Ä–µ–π—Ç–∏ –≤ –æ–Ω–ª–∞–π–Ω —Ä–µ–∂–∏–º\n"
                "‚Ä¢ /offline - –ø–µ—Ä–µ–π—Ç–∏ –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º\n"
                "‚Ä¢ /status - –ø–æ–¥—Ä–æ–±–Ω—ã–π —Å—Ç–∞—Ç—É—Å\n"
                "‚Ä¢ /questions - —Å–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –æ—Ç–≤–µ—Ç–∞\n"
                "‚Ä¢ /my_questions - –º–æ–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã\n\n"

                "üí° **–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**\n"
                "‚Ä¢ –í –æ–Ω–ª–∞–π–Ω-—Ä–µ–∂–∏–º–µ –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö\n"
                "‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /questions —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –æ–∂–∏–¥–∞—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã\n"
                "‚Ä¢ –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å –≤ —Å–ø–∏—Å–∫–µ —á—Ç–æ–±—ã –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –Ω–µ–≥–æ\n"
                "‚Ä¢ –û—Ç–≤–µ—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º\n\n"

                "‚ö° **–°–æ–≤–µ—Ç—ã:**\n"
                "‚Ä¢ –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ /questions –¥–ª—è –Ω–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤\n"
                "‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /offline –∫–æ–≥–¥–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤\n"
                "‚Ä¢ –û—Ç–≤–µ—á–∞–π—Ç–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ"
            )
        else:
            # üìã –ü–û–õ–ù–ê–Ø –°–ü–†–ê–í–ö–ê –î–õ–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô
            online_status = (
                f"üë• **–°–µ–π—á–∞—Å –æ–Ω–ª–∞–π–Ω:** {online_count} —Ñ–∞—Ä–º–∞—Ü–µ–≤—Ç(–æ–≤)\n"
                "üí¨ –í–∞—à –≤–æ–ø—Ä–æ—Å –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω –±—ã—Å—Ç—Ä–æ!\n\n"
                if online_count > 0 else
                "‚è≥ **–°–µ–π—á–∞—Å —Ñ–∞—Ä–º–∞—Ü–µ–≤—Ç–æ–≤ –Ω–µ—Ç –æ–Ω–ª–∞–π–Ω**\n"
                "üìù –í–∞—à –≤–æ–ø—Ä–æ—Å –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –ø—Ä–∏ –∏—Ö –ø–æ—è–≤–ª–µ–Ω–∏–∏\n\n"
            )

            help_text = (
                f"üíä **Novamedika Q&A Bot**\n\n"

                f"{online_status}"
                "‚ùì **–ö–∞–∫ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å:**\n"
                "1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /ask\n"
                "2. –ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ\n"
                "3. –§–∞—Ä–º–∞—Ü–µ–≤—Ç—ã –æ—Ç–≤–µ—Ç—è—Ç –≤–∞–º –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è\n"
                "4. –ü–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –æ—Ç–≤–µ—Ç–æ–º\n\n"

                "üõ† **–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:**\n"
                "‚Ä¢ /ask - –∑–∞–¥–∞—Ç—å –Ω–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å\n"
                "‚Ä¢ /my_questions - –º–æ–∏ –≤–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã\n"
                "‚Ä¢ /done - –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å\n"
                "‚Ä¢ /cancel - –æ—Ç–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ\n"
                "‚Ä¢ /help - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n\n"

                "üí° **–°–æ–≤–µ—Ç—ã –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º:**\n"
                "‚Ä¢ –û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ\n"
                "‚Ä¢ –£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞, –¥–æ–∑–∏—Ä–æ–≤–∫—É\n"
                "‚Ä¢ –ü–æ—Å–ª–µ /ask –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –∫ –≤–æ–ø—Ä–æ—Å—É\n"
                "‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /done —á—Ç–æ–±—ã –∑–∞–≤–µ—Ä—à–∏—Ç—å –≤–æ–ø—Ä–æ—Å\n\n"

                "‚è± **–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞:**\n"
                "‚Ä¢ –û–±—ã—á–Ω–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 5-15 –º–∏–Ω—É—Ç –≤ —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è\n"
                "‚Ä¢ –û—Ç–≤–µ—Ç—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏ —Ñ–∞—Ä–º–∞—Ü–µ–≤—Ç–∞–º–∏\n"
                "‚Ä¢ –í—Å–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã"
            )

        await message.answer(help_text)

    except Exception as e:
        logger.error(f"Error in universal help: {e}")
        # –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        await message.answer(
            "üíä **Novamedika Q&A Bot**\n\n"
            "–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
            "‚Ä¢ /ask - –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å —Ñ–∞—Ä–º–∞—Ü–µ–≤—Ç—É\n"
            "‚Ä¢ /my_questions - –º–æ–∏ –≤–æ–ø—Ä–æ—Å—ã\n"
            "‚Ä¢ /help - –ø–æ–ª–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞\n\n"
            "üë®‚Äç‚öïÔ∏è –î–ª—è —Ñ–∞—Ä–º–∞—Ü–µ–≤—Ç–æ–≤: /start"
        )

@router.message(Command("cancel"))
async def universal_cancel(message: Message, state: FSMContext, db: AsyncSession):
    """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –æ—Ç–º–µ–Ω–∞ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    try:
        pharmacist = await get_pharmacist_by_telegram_id(message.from_user.id, db)

        current_state = await state.get_state()
        if current_state is None:
            await message.answer("‚ÑπÔ∏è –ù–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å.")
            return

        await state.clear()

        if pharmacist:
            await message.answer("‚ùå –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ. –í–æ–∑–≤—Ä–∞—Ç –∫ —Ä–µ–∂–∏–º—É —Ñ–∞—Ä–º–∞—Ü–µ–≤—Ç–∞.")
        else:
            await message.answer("‚ùå –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")

    except Exception as e:
        logger.error(f"Error in universal cancel: {e}")
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –¥–µ–π—Å—Ç–≤–∏—è.")

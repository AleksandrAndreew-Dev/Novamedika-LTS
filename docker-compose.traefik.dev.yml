

services:
  traefik:
    image: traefik:v3.0
    container_name: traefik-dev
    command:
      - --api.dashboard=true
      - --api.insecure=true
      - --providers.docker=true
      - --providers.docker.watch=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --log.level=DEBUG
      - --accesslog=true
    ports:
      - "80:80"
      - "8080:8080"  # Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - traefik-public
    labels:
      - "traefik.enable=true"

  backend:
    build:
      context: ./backend
      target: dev
    container_name: backend-dev
    working_dir: /app/src
    volumes:
    - ./backend/src:/app/src
    environment:
    - ENVIRONMENT=development
    - CORS_ORIGINS=http://localhost,http://frontend:5173,http://127.0.0.1:5173
    - PYTHONUNBUFFERED=1
    - DATABASE_URL=postgresql+asyncpg://novamedika:novamedika@postgres:5432/novamedika_dev
    - PYTHONPATH=/app/src
    # Указываем путь к виртуальному окружению uv
    - VIRTUAL_ENV=/app/.venv
    - PATH=/app/.venv/bin:/usr/local/bin:/usr/bin:/bin
    labels:
    - "traefik.enable=true"
    - "traefik.http.routers.backend.rule=Host(`api.localhost`)"
    - "traefik.http.services.backend.loadbalancer.server.port=8000"
    - "traefik.http.routers.backend.entrypoints=web"
    networks:
    - traefik-public
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    develop:
      watch:
        - action: sync+restart
          path: ./backend/src
          target: /app/src
          ignore:
            - __pycache__/
        - action: rebuild
          path: ./backend/pyproject.toml
        - action: rebuild
          path: ./backend/uv.lock
  frontend:
    build:
      context: ./frontend
      target: dev
    container_name: frontend-dev
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
      - frontend_node_modules:/app/node_modules
    environment:
      - VITE_API_URL=http://api.localhost
      - CHOKIDAR_USEPOLLING=true
      - VITE_DEV_SERVER_HOST=0.0.0.0
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`localhost`)"
      - "traefik.http.services.frontend.loadbalancer.server.port=5173"
      - "traefik.http.routers.frontend.entrypoints=web"
    networks:
      - traefik-public
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5173"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  postgres:
    image: postgres:17
    container_name: postgres-dev
    restart: unless-stopped
    environment:
      - POSTGRES_USER=novamedika
      - POSTGRES_PASSWORD=novamedika
      - POSTGRES_DB=novamedika_prod
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - traefik-public
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U novamedika -d novamedika_dev"]
      interval: 30s
      timeout: 10s
      retries: 5
  # В docker-compose.traefik.dev.yml добавить сервис:
  celery_worker:
    build:
      context: ./backend
      target: dev
    container_name: celery-worker-dev
    working_dir: /app/src
    volumes:
      - ./backend/src:/app/src
    environment:
      - ENVIRONMENT=development
      - DATABASE_URL=postgresql+asyncpg://novamedika:novamedika@postgres:5432/novamedika_dev
      - PYTHONPATH=/app/src
      - VIRTUAL_ENV=/app/.venv
      - PATH=/app/.venv/bin:/usr/local/bin:/usr/bin:/bin
    command: /bin/bash -lc "source /app/.venv/bin/activate && celery -A tasks.tasks_increment.celery worker --loglevel=info"
    networks:
      - traefik-public
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  redis:
    image: redis:7-alpine
    container_name: redis-dev
    networks:
      - traefik-public
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Добавьте этот сервис в секцию services
  flower:
    build:
      context: ./backend
      target: dev
    container_name: flower-dev
    working_dir: /app/src
    volumes:
      - ./backend/src:/app/src
    environment:
      - ENVIRONMENT=development
      - DATABASE_URL=postgresql+asyncpg://novamedika:novamedika@postgres:5432/novamedika_dev
      - PYTHONPATH=/app/src
      - VIRTUAL_ENV=/app/.venv
      - PATH=/app/.venv/bin:/usr/local/bin:/usr/bin:/bin
    command: /bin/bash -lc "source /app/.venv/bin/activate && celery -A tasks.tasks_increment.celery flower --port=5555"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.flower.rule=Host(`flower.localhost`)"
      - "traefik.http.services.flower.loadbalancer.server.port=5555"
      - "traefik.http.routers.flower.entrypoints=web"
    networks:
      - traefik-public
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      celery_worker:
        condition: service_started

networks:
  traefik-public:
    driver: bridge

volumes:
  postgres_data:
  frontend_node_modules:
  backend_venv:


